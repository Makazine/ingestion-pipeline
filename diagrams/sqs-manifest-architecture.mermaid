graph TB
    subgraph "Data Ingestion Layer"
        S3Input["ğŸ“¦ S3 Input Bucket<br/>NDJSON Files<br/>(3.5MB each)<br/>~200,000 files/hour"]
    end
    
    subgraph "Decoupling & Reliability Layer"
        SQS["ğŸ“® SQS Queue<br/>Standard Queue<br/>â€¢ Dead Letter Queue<br/>â€¢ 14-day retention<br/>â€¢ Handles bursts<br/>~55 messages/second"]
    end
    
    subgraph "Manifest Building Layer"
        Lambda1["Î» Lambda #1<br/>Manifest Builder<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Receives SQS messages<br/>â€¢ Validates files (3.5MB Â±10%)<br/>â€¢ Groups by date prefix<br/>â€¢ Creates 1GB batches<br/>â€¢ Builds manifest files<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>512MB / 5s timeout"]
        
        DDB["ğŸ—„ï¸ DynamoDB<br/>File Tracking Table<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>PK: date_prefix<br/>SK: file_name<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ status<br/>â€¢ file_size_mb<br/>â€¢ manifest_path<br/>â€¢ job_run_id"]
        
        S3Manifest["ğŸ“¦ S3 Manifest Bucket<br/>Manifest Files<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>manifests/YYYY-MM-DD/<br/>batch-NNNN-timestamp.json<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Each ~1GB of data<br/>(~286 files)"]
        
        Quarantine["ğŸš« S3 Quarantine<br/>Invalid Files<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Wrong size<br/>â€¢ Bad format<br/>â€¢ Missing date"]
    end
    
    subgraph "Processing Layer"
        Glue["âš™ï¸ AWS Glue Streaming Job<br/>PySpark Processing<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>Configuration:<br/>â€¢ Worker: G.2X (8 vCPU, 32GB)<br/>â€¢ Workers: 10<br/>â€¢ Mode: Streaming 24/7<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>Processing:<br/>â€¢ Reads manifests continuously<br/>â€¢ Merges ~286 files per batch<br/>â€¢ Casts all to string<br/>â€¢ Converts to Parquet<br/>â€¢ Snappy compression<br/>â€¢ Date partitioning<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>Performance:<br/>â€¢ ~700 batches/hour<br/>â€¢ 2-5 min per batch<br/>â€¢ Cost: $3,168/month"]
    end
    
    subgraph "Output Layer"
        S3Output["ğŸ“¦ S3 Output Bucket<br/>Parquet Files<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>merged-parquet-YYYY-MM-DD/<br/>  â”œâ”€ part-00000.parquet<br/>  â”œâ”€ part-00001.parquet<br/>  â””â”€ ...<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>â€¢ Snappy compressed<br/>â€¢ Date partitioned<br/>â€¢ 128MB target size"]
    end
    
    subgraph "Control Plane & Monitoring"
        GlueState["ğŸ“Š Glue Job State<br/>State Changes<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ RUNNING<br/>â€¢ SUCCEEDED<br/>â€¢ FAILED<br/>â€¢ TIMEOUT"]
        
        EB["âš¡ EventBridge<br/>State Change Events<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>Triggers on:<br/>â€¢ Job completion<br/>â€¢ Job failure<br/>â€¢ Job timeout"]
        
        Lambda2["Î» Lambda #2<br/>Control Plane<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>Responsibilities:<br/>â€¢ Updates file status in DynamoDB<br/>â€¢ Detects anomalies<br/>â€¢ Publishes CloudWatch metrics<br/>â€¢ Sends SNS alerts on failures<br/>â€¢ Tracks costs & performance<br/>â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•<br/>256MB / 60s timeout"]
        
        Metrics["ğŸ—„ï¸ DynamoDB<br/>Metrics Table<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Job run stats<br/>â€¢ Execution time<br/>â€¢ DPU usage<br/>â€¢ Cost tracking<br/>â€¢ Anomalies"]
        
        CW["ğŸ“Š CloudWatch<br/>Monitoring<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Custom metrics<br/>â€¢ Job duration<br/>â€¢ Success rate<br/>â€¢ Cost per GB<br/>â€¢ Alarms"]
        
        SNS["ğŸ“§ SNS Topic<br/>Alerts<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Job failures<br/>â€¢ Timeouts<br/>â€¢ Anomalies<br/>â€¢ Cost alerts"]
    end
    
    S3Input -->|"S3 Event<br/>Notifications"| SQS
    SQS -->|"Poll messages<br/>(batch size: 10)"| Lambda1
    
    Lambda1 -->|"Track files"| DDB
    Lambda1 -->|"Create manifests<br/>(1GB batches)"| S3Manifest
    Lambda1 -->|"Invalid files"| Quarantine
    
    S3Manifest -->|"New manifest<br/>triggers job"| Glue
    
    Glue -->|"Read NDJSON<br/>files"| S3Input
    Glue -->|"Write Parquet"| S3Output
    
    Glue -->|"State changes"| GlueState
    GlueState -->|"Events"| EB
    EB -->|"Trigger"| Lambda2
    
    Lambda2 -->|"Update file<br/>status"| DDB
    Lambda2 -->|"Store metrics"| Metrics
    Lambda2 -->|"Publish<br/>metrics"| CW
    Lambda2 -->|"Send alerts<br/>on failure"| SNS
    
    style SQS fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#fff
    style Lambda1 fill:#4dabf7,stroke:#1971c2,stroke-width:2px,color:#fff
    style S3Manifest fill:#ffd43b,stroke:#f08c00,stroke-width:2px
    style Glue fill:#8b5cf6,stroke:#6d28d9,stroke-width:3px,color:#fff
    style Lambda2 fill:#51cf66,stroke:#2f9e44,stroke-width:3px,color:#fff
    style S3Input fill:#4dabf7,stroke:#1971c2,stroke-width:2px,color:#fff
    style S3Output fill:#4dabf7,stroke:#1971c2,stroke-width:2px,color:#fff
    style DDB fill:#4263eb,stroke:#364fc7,stroke-width:2px,color:#fff
    style Metrics fill:#4263eb,stroke:#364fc7,stroke-width:2px,color:#fff
    style CW fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    style SNS fill:#f59f00,stroke:#e67700,stroke-width:2px,color:#fff
    style Quarantine fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px,color:#fff
    
    classDef keyComponent fill:#51cf66,stroke:#2f9e44,stroke-width:4px,color:#fff
    class SQS,Lambda2 keyComponent
